document.write('<div id="messages"></div>'),document.write('<div id="waitingPopUp"></div>'),document.write('<div id="kanbanTasks" class="tabs"></div>');var o=null,l=null,s=null,r=null,c=null,d=null,e=compareVersions(DOL_VERSION,"5.0.7"),t=compareVersions(DOL_VERSION,"6.0.0"),n=compareVersions(DOL_VERSION,"6.0.6"),a=compareVersions(DOL_VERSION,"7.0.0"),u=compareVersions(DOL_VERSION,"8.0.0"),p=compareVersions(DOL_VERSION,"9.0.0");function g(e,i,a){var e={action:e,data:{rowid:i,progress:a}},t=($("#waitingPopUp").ejWaitingPopup().data("ejWaitingPopup").show(),$("#listactionsfilter").serialize());return $.ajax({url:document.URL.split("?")[0],type:"POST",data:t+"&token="+token+"&postData="+JSON.stringify(e),dataType:"html",async:!1,success:function(t,e){try{var n=JSON.parse(t);return token=n.token,$("#input_token").val(token),"OK"===n.status?(l.dataSource.json.forEach(function(e){e.rowid==i&&(e.progress=a+"%",e.task_status=n.data.task_status,e.progress_level=n.data.progress_level)}),o.refresh(),$(".badge").each(function(e){void 0!==n.data.kanbanHeaderCounts[this.id]&&(this.textContent=n.data.kanbanHeaderCounts[this.id])}),window.setTimeout(function(){$("#"+i).css("border-color","magenta")},100),null!=s&&s.close(),!0):(null!=(s=$("#dlgTaskEdit").data("ejDialog"))&&s.close(),$.jnotify(n.message,"warning",5e3),$("#kanbanTasks").find(".e-targetclone").remove(),$("body").css("cursor","default"),!1)}catch(e){return null!=d&&(d.cancel=!0),errText=$("<div>"+t+"</div>").text().trim(),$.jnotify(e,"error",5e3),console.log(errText),!1}},error:function(e,t,n){return null!=d&&(d.cancel=!0),$.jnotify(n,"error",5e3),!1},complete:function(e,t){$("#waitingPopUp").ejWaitingPopup().data("ejWaitingPopup").hide()}}),!0}$(function(){l=ej.DataManager(kanbanData),o=$("#kanbanTasks").ejKanban({enableTotalCount:enableNativeTotalCount,dataSource:l,locale:sfLocale,enableRTL:!1,columns:columns,keyField:"progress_level",fields:{content:"ref_libelle",primaryKey:"rowid",priority:"priority",tag:tasks_tag,title:"",color:"task_status",imageUrl:"undefined"!=typeof fieldImageUrl&&""!=fieldImageUrl?fieldImageUrl:null,collapsibleCards:{field:"",key:""}},cardSettings:{template:"",colorMapping:colorMapping,externalDropTarget:""},contextMenuSettings:{enable:!0,menuItems:[],customMenuItems:[{text:msgPrintKanbanView,target:ej.Kanban.Target.Header,template:""}]},cardDrag:function(e){var t;void 0!==$(".e-targetclone").css("top")&&(t=$(window).scrollTop(),isElementVisibleOnView($(".e-targetclone"))?$(".e-targetclone").css({position:"relative",top:0}):$(".e-targetclone").css({position:"absolute",top:t}))},cardDragStop:function(e){tooltipsActive=!1,r=(c=d=e).data[0][0];var t=$(e.draggedElement).prop("id"),n=$(e.draggedElement).parent().data("ej-mappingkey"),i=$(e.dropTarget).parent().data("ej-mappingkey");void 0===n||void 0===i||i===n?(e.cancel=!0,$("#kanbanTasks").find(".e-targetclone").remove(),$("body").css("cursor","default")):"TASK_DONE"!=i&&"TASK_NOT_STARTED"!=i?(e.cancel=!0,a.setValue(parseInt(r.progress)),null!=s&&s.open()):"TASK_DONE"==i?(e.cancel=!0,g("kanbanTasks_cardDragStop",t,100)):"TASK_NOT_STARTED"==i?(e.cancel=!0,g("kanbanTasks_cardDragStop",t,0)):tooltipsActive=!1},cardDrop:function(e){},cardClick:function(e){if(r=e.data[0],c=e,!tooltipsActive){var t,n,a=l.dataSource.json.length;for(i=0;i<a;i++)t=l.dataSource.json[i].rowid,n=l.dataSource.json[i].tooltip_content,$("#task-"+t).ejTooltip({content:n}),t==r.rowid&&($(".tooltip-progress-"+t).each(function(e){$(this).text(l.dataSource.json[i].progress)}),$(".tooltip-ref-"+t).each(function(e){$(this).text(l.dataSource.json[i].ref)}));tooltipsActive=!0}},contextClick:function(e){"ejMenuClick"!=e.type&&"contextClick"!=e.type||e.text!=msgPrintKanbanView||this.print()},create:function(e){},queryCellInfo:function(e){$(e.card).find("td.e-imagecell").html("");var i,a,t=e.data.rowid;void 0!==tasksResources[t]&&null!=tasksResources[t]&&(i="",a=$(e.card).find("td.e-imagecell"),tasksResources[t].forEach(function(e){i="","TASKEXECUTIVE"==e.taskResourceType&&(i="taskexecutive");var t="",n='<div class="e-image e-no-user"></div>';-1==p&&(t="/0"),0<e.taskResourceIdWithSource.indexOf("-I")?("unknown"!=$("#kanbanTasks").ejKanban("model.fields.imageUrl")&&(n='<img class="e-image '+i+'" src="'+DOL_URL_ROOT+"/viewimage.php?modulepart=user&file="+e.taskResourceId+t+"/"+encodeURI(e.taskResourcePhoto)+'">'),a.append('<div class="e-card_link">\n                                  <a href="'+DOL_URL_ROOT+"/user/card.php?id="+e.taskResourceId+'" title="'+e.taskResourceName+'" target="_blank">\n                                    <div class="e-card_image">\n                                       '+n+"\n                                    </div>\n                                  </a>\n                                </div>")):("unknown"!=$("#kanbanTasks").ejKanban("model.fields.imageUrl")&&(n='<img class="e-image '+i+'" src="'+DOL_URL_ROOT+"/viewimage.php?modulepart=societe&file=contact/"+e.taskResourceId+"/photos/"+encodeURI(e.taskResourcePhoto)+'">'),a.append('<div class="e-card_link">\n                                  <a href="'+DOL_URL_ROOT+"/contact/card.php?id="+e.taskResourceId+'" title="'+e.taskResourceName+'" target="_blank">\n                                    <div class="e-card_image">\n                                       '+n+"\n                                    </div>\n                                  </a>\n                                </div>"))})),void 0!==e.data.progress&&null!=e.data.progress||(e.data.progress="0%"),$(e.card).find("td.e-imagecell").prepend('<div class="progress-container" title="'+parseInt(e.data.progress)+'%"><div class="progress-value" style="width: '+parseInt(e.data.progress)+'%"></div></div>')}}).data("ejKanban"),s=$("#dlgTaskEdit").ejDialog({title:msgDlgTaskEditTitle,enableModal:!0,enableResize:!1,locale:locale,enableRTL:!1,showOnInit:!1,width:400}).data("ejDialog");var a=$("#dlgTaskEdit_sliderProgressChoice").ejSlider({sliderType:ej.SliderType.MinRange,showScale:!0,showSmallTicks:!1,height:20,width:350,value:0,minValue:0,maxValue:100,incrementStep:1,change:function(e){$("#dlgTaskEdit_sliderValue").text(e.model.value)},slide:function(e){$("#dlgTaskEdit_sliderValue").text(e.model.value)}}).data("ejSlider");$("#dlgTaskEdit_btnOK").ejButton({type:"button",size:"mini",showRoundedCorner:!0,click:function(e){var t,n;null!=r&&(t=parseInt(r.progress),(n=parseInt(a.getValue()))!==t)&&g("dlgTaskEdit_btnOK_click",r.rowid,n)}}),$("#dlgTaskEdit_btnCancel").ejButton({type:ej.ButtonType.Button,size:"mini",showRoundedCorner:!0,click:function(e){null!=d&&(d.cancel=!0),s.close(),$("#kanbanTasks").find(".e-targetclone").remove(),$("body").css("cursor","default")}}),$("#fk_projet_input_filtre").on("change",function(e){""!=$(this).val()&&$("#fk_soc_input_filtre").val(""),e.stopPropagation()}),$("#fk_soc_input_filtre").on("change",function(e){""!=$(this).val()&&$("#fk_projet_input_filtre").val(""),e.stopPropagation()})}),window.onerror=function(e,t,n,i,a){return $("#waitingPopUp").ejWaitingPopup().data("ejWaitingPopup").hide(),console.log(e),!1};