document.write('<div id="messages"></div>'),document.write('<div id="waitingPopUp"></div>'),document.write('<div id="kanban_invoices" class="tabs"></div>');var l=null,c=null,r=null,e={},d=(e[invoice_late_status_0]="INVOICE_LATE_STATUS_0",e[invoice_late_status_1]="INVOICE_LATE_STATUS_1",e[invoice_late_status_2]="INVOICE_LATE_STATUS_2",e[invoice_late_status_3]="INVOICE_LATE_STATUS_3",null),s=null,n=compareVersions(DOL_VERSION,"5.0.7"),I=compareVersions(DOL_VERSION,"6.0.0"),t=compareVersions(DOL_VERSION,"6.0.6"),o=compareVersions(DOL_VERSION,"7.0.0"),a=compareVersions(DOL_VERSION,"8.0.0");function _(e,n,t,o,i,a){null==o&&(o=""),null==i&&(i=""),null==a&&(a="");var l=document.URL.split("?")[0],c=(l=(l=(l=(l+="?"+$("#listactionsfilter").serialize())+("&id="+n+"&newStatusID="+t+"&action=cardDrop")+("&idwarehouse="+o))+("&close_code="+i)+("&close_note="+a))+("&token="+token),l=encodeURI(l),$("#waitingPopUp").ejWaitingPopup().data("ejWaitingPopup").show(),"");return $.ajax({url:l,type:"GET",dataType:"html",async:!1,success:function(e,n){try{console.log(e);var t=JSON.parse(e);token=t.token,$("#input_token").val(token),"OK"===t.status?(""!=t.message&&$.jnotify(t.message),c=void 0!==t.data.newRef?"OK||"+t.data.newRef:"OK",$(".badge").each(function(e){void 0!==t.data.kanbanHeaderCounts[this.id]&&(this.textContent=t.data.kanbanHeaderCounts[this.id])}),$(".total_amount").each(function(e){var n=this.id.split("-")[1];void 0!==t.data.columnsAmountTotal[n]&&(this.textContent=t.data.columnsAmountTotal[n])})):($.jnotify(t.message,"warning",5e3),$("#kanban_invoices").find(".e-targetclone").remove(),$("body").css("cursor","default"),c="KO")}catch(e){$.jnotify(e,"error",5e3),c="KO"}},error:function(e,n,t){alert(t),c="KO"},complete:function(e,n){$("#waitingPopUp").ejWaitingPopup().data("ejWaitingPopup").hide()}}),c}$(function(){d=ej.DataManager(kanbanData),s=$("#kanban_invoices").ejKanban({enableTotalCount:enableNativeTotalCount,dataSource:d,locale:sfLocale,enableRTL:!1,columns:columns,keyField:"kanban_status",fields:{content:"facnumber_tiers",primaryKey:"rowid",priority:"priority",tag:invoices_tag,title:"",color:"late_status",imageUrl:"undefined"!=typeof fieldImageUrl&&""!=fieldImageUrl?fieldImageUrl:null,collapsibleCards:{field:"",key:""}},cardSettings:{colorMapping:e,template:"",externalDropTarget:""},contextMenuSettings:{enable:!0,menuItems:[],customMenuItems:[{text:msgPrintKanbanView,target:ej.Kanban.Target.Header,template:""}]},cardDrag:function(e){var n;void 0!==$(".e-targetclone").css("top")&&(n=$(window).scrollTop(),isElementVisibleOnView($(".e-targetclone"))?$(".e-targetclone").css({position:"relative",top:0}):$(".e-targetclone").css({position:"absolute",top:n}))},cardDragStop:function(e){var n=$(e.draggedElement).parent().data("ej-mappingkey"),t=$(e.dropTarget).parent().data("ej-mappingkey"),o=columnIDs[t];if(void 0===t||void 0===n||t===n||"INVOICE_VALIDATED"!==t&&"INVOICE_DRAFT"===n||"INVOICE_PAID"===t&&"INVOICE_TO_CLASSIFY_PAID"!==n&&"INVOICE_PARTIALLY_PAID"!==n||"INVOICE_VALIDATED"===t&&e.data[0][0].nbre_lignes<=0||"INVOICE_ABANDONED"===t&&"INVOICE_PARTIALLY_PAID"===n||"INVOICE_LATE"===t||"INVOICE_PARTIALLY_PAID"===t&&("INVOICE_PAID"!==n||e.data[0][0].total_paye===e.data[0][0].total_ttc)||"INVOICE_TO_CLASSIFY_PAID"===t)e.cancel=!0,$("#kanban_invoices").find(".e-targetclone").remove(),$("body").css("cursor","default"),"INVOICE_VALIDATED"===t&&e.data[0][0].nbre_lignes<=0?$.jnotify(ActionNotAllowed_EmptyInvoice,"warning"):"INVOICE_VALIDATED"!==t&&"INVOICE_DRAFT"===n?$.jnotify(ActionNotAllowed_YouMustValidateFirst,"warning"):$.jnotify(ActionNotAllowed,"warning");else{if("INVOICE_VALIDATED"==t&&"INVOICE_DRAFT"==n){if(stock_enabled&&e.data[0][0].qualified_for_stock_change)return warehouseListEmpty?$.jnotify(ValidationNotAllowed_NoWarehouse,"error"):(draggedItemRowid=e.data[0][0].rowid,$("#warehouse_choice_dialog").ejDialog("open")),e.cancel=!0,$("#kanban_invoices").find(".e-targetclone").remove(),void $("body").css("cursor","default")}else{if("INVOICE_PAID"==t&&"INVOICE_PARTIALLY_PAID"==n)return draggedItemRowid=e.data[0][0].rowid,$("#set_paid_dialog").ejDialog("open"),e.cancel=!0,$("#kanban_invoices").find(".e-targetclone").remove(),void $("body").css("cursor","default");if("INVOICE_ABANDONED"==t&&("INVOICE_VALIDATED"==n||"INVOICE_LATE"==n))return draggedItemRowid=e.data[0][0].rowid,$("#set_abandoned_dialog").ejDialog("open"),e.cancel=!0,$("#kanban_invoices").find(".e-targetclone").remove(),void $("body").css("cursor","default")}var i,a,l=$(e.draggedElement).prop("id"),o=_(e,l,o,"");"KO"!=o?(i=kanbanData.find(function(e){return e.rowid===l}),"INVOICE_VALIDATED"==t&&"INVOICE_DRAFT"==n?(a="",1<(o=o.split("||")).length&&(a=o[1].trim()),i.late?(e.cancel=!0,i.kanban_status="INVOICE_LATE"):i.kanban_status="INVOICE_VALIDATED",""!==a&&(i.facnumber=a,o='<div id="invoice-'+i.rowid+'">',i.facnumber_tiers='<a class="object-link" href="'+DOL_URL_ROOT+(-1===I?"/compta/facture.php?facid=":"/compta/facture/card.php?id=")+i.rowid+'" target="_blank">'+i.facnumber+"</a>"+o+i.societe_nom+"</div>"),s.refresh(!0)):"INVOICE_VALIDATED"==t&&"INVOICE_DRAFT"!=n&&(e.cancel=!0,i.late?i.kanban_status="INVOICE_LATE":parseFloat(i.total_paye)>=parseFloat(i.total_ttc)?i.kanban_status="INVOICE_TO_CLASSIFY_PAID":0<parseFloat(i.total_paye)&&parseFloat(i.total_paye)<parseFloat(i.total_ttc)?i.kanban_status="INVOICE_PARTIALLY_PAID":i.kanban_status="INVOICE_VALIDATED",s.refresh(!0)),window.setTimeout(function(){$("#"+l).css("border-color","magenta")},100)):(e.cancel=!0,$("#kanban_invoices").find(".e-targetclone").remove(),$("body").css("cursor","default")),tooltipsActive=!1}},cardDrop:function(e){},cardClick:function(e){if(!tooltipsActive){console.log(tooltipsActive);var n,t,o=d.dataSource.json.length;for(i=0;i<o;i++)n=d.dataSource.json[i].rowid,t=d.dataSource.json[i].tooltip_content,$("#invoice-"+n).ejTooltip({content:t}),$(".tooltip-ref-"+n).each(function(e){$(this).text(d.dataSource.json[i].facnumber)});tooltipsActive=!0}},contextClick:function(e){"ejMenuClick"!=e.type&&"contextClick"!=e.type||e.text!=msgPrintKanbanView||this.print()},queryCellInfo:function(e){var n=-1===I?"soc.php":"card.php";null!=e.data.fk_soc&&""!=e.data.fk_soc&&null!=e.data.societe_nom&&""!=e.data.societe_nom&&$(e.card).find("div.e-card_image").wrap('<a href="'+DOL_URL_ROOT+"/societe/"+n+"?socid="+e.data.fk_soc+'" title="'+e.data.societe_nom+'" target="_blank"></a>')}}).data("ejKanban"),l=$("#warehouse_choice_dialog").ejDialog({title:msgWarehouseChoice,enableModal:!0,enableResize:!1,locale:sfLocale,enableRTL:!1,showOnInit:!1}).data("ejDialog");var a=$("#warehouse_choice_list").ejListBox({itemsCount:5}).data("ejListBox"),t=($("#btnOK_Warehouse").ejButton({type:"button",size:"mini",showRoundedCorner:!0,click:function(e){var n,t,o=0;0<(o=0<a.getSelectedItems().length?a.getSelectedItems()[0].value:o)&&"KO"!==(o=_(null,draggedItemRowid,"INVOICE_VALIDATED",o))&&(n=kanbanData.find(function(e){return e.rowid===draggedItemRowid}),t="",1<(o=o.split("||")).length&&(t=o[1].trim()),n.late?n.kanban_status="INVOICE_LATE":n.kanban_status="INVOICE_VALIDATED",""!==t&&(n.facnumber=t,o='<div id="invoice-'+n.rowid+'">',n.facnumber_tiers='<a class="object-link" href="'+DOL_URL_ROOT+(-1===I?"/compta/facture.php?facid=":"/compta/facture/card.php?id=")+n.rowid+'" target="_blank">'+n.facnumber+"</a>"+o+n.societe_nom+"</div>"),s.refresh(!0)),l.close(),window.setTimeout(function(){$("#"+draggedItemRowid).css("border-color","magenta")},100)}}),$("#btnCancel_Warehouse").ejButton({type:ej.ButtonType.Button,size:"mini",showRoundedCorner:!0,click:function(e){l.close()}}),c=$("#set_paid_dialog").ejDialog({title:msgInvoice_SetPaid_DialogTitle,enableModal:!0,enableResize:!1,locale:sfLocale,enableRTL:!1,showOnInit:!1}).data("ejDialog"),$("#set_paid_reason_choice_list").ejListBox({itemsCount:3,width:370,select:function(e){$("#btnOK_SetPaid").ejButton({enabled:!0})}}).data("ejListBox")),o=($("#txtReason_SetPaid"),$("#btnOK_SetPaid").ejButton({type:"button",size:"mini",showRoundedCorner:!0,enabled:!1,click:function(e){var n=0;void 0!==(n=0<t.getSelectedItems().length?t.getSelectedItems()[0].value:n)&&""!=n&&("KO"!==_(null,draggedItemRowid,"INVOICE_PAID","",n,$("#txtReason_SetPaid").val())&&(kanbanData.find(function(e){return e.rowid===draggedItemRowid}).kanban_status="INVOICE_PAID",s.refresh(!0)),window.setTimeout(function(){$("#"+draggedItemRowid).css("border-color","magenta")},100)),c.close()}}),$("#btnCancel_SetPaid").ejButton({type:ej.ButtonType.Button,size:"mini",showRoundedCorner:!0,click:function(e){c.close()}}),r=$("#set_abandoned_dialog").ejDialog({title:msgInvoice_SetAbandoned_DialogTitle,enableModal:!0,enableResize:!1,locale:sfLocale,enableRTL:!1,showOnInit:!1}).data("ejDialog"),$("#set_abandoned_reason_choice_list").ejListBox({itemsCount:3,width:370,select:function(e){$("#btnOK_SetAbandoned").ejButton({enabled:!0})}}).data("ejListBox"));$("#txtReason_SetAbandoned"),$("#btnOK_SetAbandoned").ejButton({type:"button",size:"mini",enabled:!1,showRoundedCorner:!0,click:function(e){var n=0;void 0!==(n=0<o.getSelectedItems().length?o.getSelectedItems()[0].value:n)&&""!=n&&"KO"!==_(null,draggedItemRowid,"INVOICE_ABANDONED","",n,$("#txtReason_SetAbandoned").val())&&(kanbanData.find(function(e){return e.rowid===draggedItemRowid}).kanban_status="INVOICE_ABANDONED",s.refresh(!0)),r.close(),window.setTimeout(function(){$("#"+draggedItemRowid).css("border-color","magenta")},100)}}).data("ejButton");$("#btnCancel_SetAbandoned").ejButton({type:ej.ButtonType.Button,size:"mini",showRoundedCorner:!0,click:function(e){r.close()}})}),window.onerror=function(e,n,t,o,i){return $("#waitingPopUp").ejWaitingPopup().data("ejWaitingPopup").hide(),console.log(e),!1};