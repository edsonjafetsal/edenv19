document.write('<div id="messages"></div>'),document.write('<div id="waitingPopUp"></div>'),document.write('<div id="kanban_orders" class="tabs"></div>');var e={},c=(e[order_late_status_0]="ORDER_LATE_STATUS_0",e[order_late_status_1]="ORDER_LATE_STATUS_1",e[order_late_status_2]="ORDER_LATE_STATUS_2",e[order_late_status_3]="ORDER_LATE_STATUS_3",null),s=null,t=compareVersions(DOL_VERSION,"5.0.7"),o=compareVersions(DOL_VERSION,"6.0.0"),n=compareVersions(DOL_VERSION,"6.0.6"),a=compareVersions(DOL_VERSION,"7.0.0"),r=compareVersions(DOL_VERSION,"8.0.0");function d(e,t,o,n){null==n&&(n="");var a=document.URL.split("?")[0],i=(a=(a=a+("?"+$("#listactionsfilter").serialize())+("&id="+t+"&newStatusID="+o+"&action=cardDrop&idwarehouse="+n))+("&token="+token),$("#waitingPopUp").ejWaitingPopup().data("ejWaitingPopup").show(),"");return $.ajax({url:a,type:"GET",dataType:"html",async:!1,success:function(t,e){try{var o=JSON.parse(t);token=o.token,$("#input_token").val(token),"OK"===o.status?(""!=o.message&&$.jnotify(o.message),i=void 0!==o.data.newRef?"OK||"+o.data.newRef:"OK",$(".badge").each(function(e){void 0!==o.data.kanbanHeaderCounts[this.id]&&(this.textContent=o.data.kanbanHeaderCounts[this.id])}),$(".total_amount").each(function(e){var t=this.id.split("-")[1];void 0!==o.data.columnsAmountTotal[t]&&(this.textContent=o.data.columnsAmountTotal[t])})):($.jnotify(o.message,"warning",5e3),$("#kanban_orders").find(".e-targetclone").remove(),$("body").css("cursor","default"),i="KO")}catch(e){$.jnotify(e,"error",5e3),console.log(t),i="KO"}},error:function(e,t,o){alert(o),i="KO"},complete:function(e,t){$("#waitingPopUp").ejWaitingPopup().data("ejWaitingPopup").hide()}}),i}$(function(){var r=0,a=(c=ej.DataManager(kanbanData),s=$("#kanban_orders").ejKanban({enableTotalCount:enableNativeTotalCount,dataSource:c,locale:sfLocale,enableRTL:!1,columns:columns,keyField:"kanban_status",fields:{content:"ref_tiers",primaryKey:"rowid",priority:"priority",tag:orders_tag,title:"",color:"late_status",imageUrl:"undefined"!=typeof fieldImageUrl&&""!=fieldImageUrl?fieldImageUrl:null,collapsibleCards:{field:"",key:""}},cardSettings:{template:"",colorMapping:e,externalDropTarget:""},contextMenuSettings:{enable:!0,menuItems:[],customMenuItems:[{text:msgPrintKanbanView,target:ej.Kanban.Target.Header,template:""}]},cardDrag:function(e){var t;void 0!==$(".e-targetclone").css("top")&&(t=$(window).scrollTop(),isElementVisibleOnView($(".e-targetclone"))?$(".e-targetclone").css({position:"relative",top:0}):$(".e-targetclone").css({position:"absolute",top:t}))},cardDragStop:function(e){r=0;var t,o=$(e.draggedElement).parent().data("ej-mappingkey"),n=$(e.dropTarget).parent().data("ej-mappingkey"),a=columnIDs[n];void 0===n||void 0===o||n==o||"ORDER_VALIDATED"!=n&&"ORDER_DRAFT"==o||"ORDER_VALIDATED"==n&&e.data[0][0].nbre_lignes<=0?(e.cancel=!0,$("#kanban_orders").find(".e-targetclone").remove(),$("body").css("cursor","default"),"ORDER_VALIDATED"==n&&e.data[0][0].nbre_lignes<=0?$.jnotify(ActionNotAllowed_EmptyOrder,"warning"):"ORDER_VALIDATED"!=n&&"ORDER_DRAFT"==o?$.jnotify(ActionNotAllowed_YouMustValidateFirst,"warning"):$.jnotify(ActionNotAllowed,"warning")):"ORDER_VALIDATED"==n&&"ORDER_DRAFT"==o&&stock_enabled&&STOCK_CALCULATE_ON_VALIDATE_ORDER&&e.data[0][0].qualified_for_stock_change?(warehouseListEmpty?$.jnotify(ValidationNotAllowed_NoWarehouse,"error"):(r=e.data[0][0].rowid,$("#warehouse_choice_dialog").ejDialog("open")),e.cancel=!0,$("#kanban_orders").find(".e-targetclone").remove(),$("body").css("cursor","default")):("KO"!==(a=d(e,t=$(e.draggedElement).prop("id"),a,""))?("ORDER_VALIDATED"==n&&"ORDER_DRAFT"==o&&(n=kanbanData.find(function(e){return e.rowid===t}),(o="")!==(o=1<(a=a.split("||")).length?a[1].trim():o)&&(n.ref=o,a='<div id="order-'+n.rowid+'">',n.ref_tiers='<a class="object-link" href="'+DOL_URL_ROOT+"/commande/card.php?id="+n.rowid+'" target="_blank">'+n.ref+"</a>"+a+n.societe_nom+"</div>",n.ref_date_commande=n.ref+" - "+n.date_commande,n.ref_date_livraison=n.ref+" - "+n.date_livraison),s.refresh()),window.setTimeout(function(){$("#"+t).css("border-color","magenta")},100)):(e.cancel=!0,$("#kanban_invoices").find(".e-targetclone").remove(),$("body").css("cursor","default")),tooltipsActive=!1)},cardDrop:function(e){},cardClick:function(e){if(!tooltipsActive){console.log(tooltipsActive);var t,o,n=c.dataSource.json.length;for(i=0;i<n;i++)t=c.dataSource.json[i].rowid,o=c.dataSource.json[i].tooltip_content,$("#order-"+t).ejTooltip({content:o}),$(".tooltip-ref-"+t).each(function(e){$(this).text(c.dataSource.json[i].ref)});tooltipsActive=!0}},contextClick:function(e){"ejMenuClick"!=e.type&&"contextClick"!=e.type||e.text!=msgPrintKanbanView||this.print()},queryCellInfo:function(e){var t=-1===o?"soc.php":"card.php";null!=e.data.fk_soc&&""!=e.data.fk_soc&&null!=e.data.societe_nom&&""!=e.data.societe_nom&&$(e.card).find("div.e-card_image").wrap('<a href="'+DOL_URL_ROOT+"/societe/"+t+"?socid="+e.data.fk_soc+'" title="'+e.data.societe_nom+'" target="_blank"></a>')}}).data("ejKanban"),$("#warehouse_choice_dialog").ejDialog({title:WarehouseChoice,enableModal:!0,enableResize:!1,locale:sfLocale,enableRTL:!1,showOnInit:!1}).data("ejDialog")),l=$("#warehouse_choice_list").ejListBox({itemsCount:5}).data("ejListBox");$("#btnOK").ejButton({type:"button",size:"mini",showRoundedCorner:!0,click:function(e){var t,o,n=0;0<(n=0<l.getSelectedItems().length?l.getSelectedItems()[0].value:n)&&("KO"!==(n=d(null,r,"ORDER_VALIDATED",n))&&(t=kanbanData.find(function(e){return e.rowid===r}),o="",1<(n=n.split("||")).length&&(o=n[1].trim()),t.kanban_status="ORDER_VALIDATED",""!==o&&(t.ref=o,n='<div id="order-'+t.rowid+'">',t.ref_tiers='<a class="object-link" href="'+DOL_URL_ROOT+"/commande/card.php?id="+t.rowid+'" target="_blank">'+t.ref+"</a>"+n+t.societe_nom+"</div>",t.ref_date_commande=t.ref+" - "+t.date_commande,t.ref_date_livraison=t.ref+" - "+t.date_livraison),s.refresh()),window.setTimeout(function(){$("#"+r).css("border-color","magenta")},100)),a.close()}}),$("#btnCancel").ejButton({type:ej.ButtonType.Button,size:"mini",showRoundedCorner:!0,click:function(e){a.close()}})}),window.onerror=function(e,t,o,n,a){return $("#waitingPopUp").ejWaitingPopup().data("ejWaitingPopup").hide(),console.log(e),!1};