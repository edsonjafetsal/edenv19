document.write('<div id="messages"></div>'),document.write('<div id="waitingPopUp"></div>'),document.write('<div id="kanbanInvoicesSuppliers" class="tabs"></div>');var r=null,e={},l=(e[invoice_late_status_0]="INVOICE_LATE_STATUS_0",e[invoice_late_status_1]="INVOICE_LATE_STATUS_1",e[invoice_late_status_2]="INVOICE_LATE_STATUS_2",e[invoice_late_status_3]="INVOICE_LATE_STATUS_3",null),c=null,o=compareVersions(DOL_VERSION,"5.0.7"),t=compareVersions(DOL_VERSION,"6.0.0"),n=compareVersions(DOL_VERSION,"6.0.6"),a=compareVersions(DOL_VERSION,"7.0.0"),I=compareVersions(DOL_VERSION,"8.0.0");function s(e,o,t,n,i,a){null==n&&(n=""),null==i&&(i=""),null==a&&(a="");var r=document.URL.split("?")[0],l=(r=(r=(r=(r+="?"+$("#listactionsfilter").serialize())+("&id="+o+"&newStatusID="+t+"&action=cardDrop")+("&idwarehouse="+n))+("&close_code="+i)+("&close_note="+a))+("&token="+token),r=encodeURI(r),$("#waitingPopUp").ejWaitingPopup().data("ejWaitingPopup").show(),"");return $.ajax({url:r,type:"GET",dataType:"html",async:!1,success:function(e,o){try{console.log(e);var t=JSON.parse(e);token=t.token,$("#input_token").val(token),"OK"===t.status?(""!=t.message&&$.jnotify(t.message),l=void 0!==t.data.newRef?"OK||"+t.data.newRef:"OK",$(".badge").each(function(e){void 0!==t.data.kanbanHeaderCounts[this.id]&&(this.textContent=t.data.kanbanHeaderCounts[this.id])}),$(".total_amount").each(function(e){var o=this.id.split("-")[1];void 0!==t.data.columnsAmountTotal[o]&&(this.textContent=t.data.columnsAmountTotal[o])})):($.jnotify(t.message,"warning",5e3),$("#kanbanInvoicesSuppliers").find(".e-targetclone").remove(),$("body").css("cursor","default"),l="KO")}catch(e){$.jnotify(e,"error",5e3),l="KO"}},error:function(e,o,t){alert(t),l="KO"},complete:function(e,o){$("#waitingPopUp").ejWaitingPopup().data("ejWaitingPopup").hide()}}),l}$(function(){l=ej.DataManager(kanbanData),c=$("#kanbanInvoicesSuppliers").ejKanban({enableTotalCount:enableNativeTotalCount,dataSource:l,locale:sfLocale,enableRTL:!1,columns:columns,keyField:"kanban_status",fields:{content:"ref_tiers",primaryKey:"rowid",priority:"priority",tag:invoices_tag,title:"",color:"late_status",imageUrl:"undefined"!=typeof fieldImageUrl&&""!=fieldImageUrl?fieldImageUrl:null,collapsibleCards:{field:"",key:""}},cardSettings:{colorMapping:e,template:"",externalDropTarget:""},contextMenuSettings:{enable:!0,menuItems:[],customMenuItems:[{text:msgPrintKanbanView,target:ej.Kanban.Target.Header,template:""}]},cardDrag:function(e){var o;void 0!==$(".e-targetclone").css("top")&&(o=$(window).scrollTop(),isElementVisibleOnView($(".e-targetclone"))?$(".e-targetclone").css({position:"relative",top:0}):$(".e-targetclone").css({position:"absolute",top:o}))},cardDragStop:function(e){var o,t,n,i=$(e.draggedElement).parent().data("ej-mappingkey"),a=$(e.dropTarget).parent().data("ej-mappingkey"),r=columnIDs[a];void 0===a||void 0===i||a===i||"INVOICE_VALIDATED"!==a&&"INVOICE_DRAFT"===i||"INVOICE_VALIDATED"===a&&"INVOICE_LATE"===i||"INVOICE_PAID"===a&&"INVOICE_TO_CLASSIFY_PAID"!==i&&"INVOICE_PARTIALLY_PAID"!==i&&"INVOICE_LATE"!==i||"INVOICE_VALIDATED"===a&&e.data[0][0].nbre_lignes<=0||"INVOICE_LATE"===a||"INVOICE_PARTIALLY_PAID"===a&&("INVOICE_PAID"!==i||e.data[0][0].total_paye===e.data[0][0].total_ttc)||"INVOICE_TO_CLASSIFY_PAID"===a?(e.cancel=!0,$("#kanbanInvoicesSuppliers").find(".e-targetclone").remove(),$("body").css("cursor","default"),"INVOICE_VALIDATED"===a&&e.data[0][0].nbre_lignes<=0?$.jnotify(ActionNotAllowed_EmptyInvoice,"warning"):"INVOICE_VALIDATED"!==a&&"INVOICE_DRAFT"===i?$.jnotify(ActionNotAllowed_YouMustValidateFirst,"warning"):$.jnotify(ActionNotAllowed,"warning")):"INVOICE_VALIDATED"==a&&"INVOICE_DRAFT"==i&&stock_enabled&&e.data[0][0].qualified_for_stock_change?(warehouseListEmpty?$.jnotify(ValidationNotAllowed_NoWarehouse,"error"):(draggedItemRowid=e.data[0][0].rowid,$("#warehouse_choice_dialog").ejDialog("open")),e.cancel=!0,$("#kanbanInvoicesSuppliers").find(".e-targetclone").remove(),$("body").css("cursor","default")):(o=$(e.draggedElement).prop("id"),console.log("id="+o),"KO"!=(r=s(e,o,r,""))?(t=kanbanData.find(function(e){return e.rowid===o}),"INVOICE_VALIDATED"==a&&"INVOICE_DRAFT"==i?(n="",1<(r=r.split("||")).length&&(n=r[1].trim()),t.kanban_status="INVOICE_VALIDATED",""!==n&&(t.ref=n,r='<div id="invoice-'+t.rowid+'">',t.ref_tiers='<a class="object-link" href="'+DOL_URL_ROOT+"/fourn/facture/card.php?facid="+t.rowid+'" target="_blank">'+t.ref+"</a>"+r+t.societe_nom+"</div>"),c.refresh(!0)):"INVOICE_VALIDATED"==a&&"INVOICE_DRAFT"!=i&&(e.cancel=!0,parseFloat(t.total_paye)>=parseFloat(t.total_ttc)?t.kanban_status="INVOICE_TO_CLASSIFY_PAID":0<parseFloat(t.total_paye)&&parseFloat(t.total_paye)<parseFloat(t.total_ttc)?t.kanban_status="INVOICE_PARTIALLY_PAID":t.kanban_status="INVOICE_VALIDATED",c.refresh(!0)),window.setTimeout(function(){$("#"+o).css("border-color","magenta")},100)):(e.cancel=!0,$("#kanbanInvoicesSuppliers").find(".e-targetclone").remove(),$("body").css("cursor","default")),tooltipsActive=!1)},cardDrop:function(e){},cardClick:function(e){if(!tooltipsActive){var o,t,n=l.dataSource.json.length;for(i=0;i<n;i++)o=l.dataSource.json[i].rowid,t=l.dataSource.json[i].tooltip_content,$("#invoice-"+o).ejTooltip({content:t}),$(".tooltip-ref-"+o).each(function(e){$(this).text(l.dataSource.json[i].ref)});tooltipsActive=!0}},contextClick:function(e){"ejMenuClick"!=e.type&&"contextClick"!=e.type||e.text!=msgPrintKanbanView||this.print()},queryCellInfo:function(e){var o=-1===t?"soc.php":"card.php";null!=e.data.fk_soc&&""!=e.data.fk_soc&&null!=e.data.societe_nom&&""!=e.data.societe_nom&&$(e.card).find("div.e-card_image").wrap('<a href="'+DOL_URL_ROOT+"/societe/"+o+"?socid="+e.data.fk_soc+'" title="'+e.data.societe_nom+'" target="_blank"></a>')}}).data("ejKanban"),r=$("#warehouse_choice_dialog").ejDialog({title:msgWarehouseToIncrementDialogTitle,enableModal:!0,enableResize:!1,locale:sfLocale,enableRTL:!1,showOnInit:!1}).data("ejDialog");var a=$("#warehouse_choice_list").ejListBox({itemsCount:5}).data("ejListBox");$("#btnOK_Warehouse").ejButton({type:"button",size:"mini",showRoundedCorner:!0,click:function(e){var o,t,n=0;0<(n=0<a.getSelectedItems().length?a.getSelectedItems()[0].value:n)&&(console.log("draggedItemRowid : "+draggedItemRowid),"KO"!==(n=s(null,draggedItemRowid,"INVOICE_VALIDATED",n)))&&(o=kanbanData.find(function(e){return e.rowid===draggedItemRowid}),t="",1<(n=n.split("||")).length&&(t=n[1].trim()),o.total_paye>=o.total_ttc?o.kanban_status="INVOICE_TO_CLASSIFY_PAID":0<o.total_paye&&o.total_paye<o.total_ttc?o.kanban_status="INVOICE_PARTIALLY_PAID":o.kanban_status="INVOICE_VALIDATED",""!==t&&(o.ref=t,n='<div id="invoice-'+o.rowid+'">',o.ref_tiers='<a class="object-link" href="'+DOL_URL_ROOT+"/fourn/facture/card.php?facid="+o.rowid+'" target="_blank">'+o.ref+"</a>"+n+o.societe_nom+"</div>"),c.refresh()),r.close(),window.setTimeout(function(){$("#"+draggedItemRowid).css("border-color","magenta")},100)}}),$("#btnCancel_Warehouse").ejButton({type:ej.ButtonType.Button,size:"mini",showRoundedCorner:!0,click:function(e){r.close()}})}),window.onerror=function(e,o,t,n,i){return $("#waitingPopUp").ejWaitingPopup().data("ejWaitingPopup").hide(),console.log(e),!1};